<html>
   <head>
      <title>Group Explorer Library</title>

      <link rel="icon" type="image/png" href="./images/favicon.png"></link>
      <link rel="stylesheet" href="./style/fonts.css" type="text/css"></link>
      <link rel="stylesheet" href="./style/menu.css" type="text/css"></link>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

      <style type="text/css">
       .hidden {
          display: none;
       }
       table, th, td {
          border: 1px solid #A0A0A0;
          border-collapse: collapse;
          vertical-align: middle;
       }
       .diagramHeader {
          width: 100px;
       }
       .groupName {
          font-size: large;
       }
       .groupOrder {
          text-align: center;
       }
       .cayleyDiagram, .multiplicationTable, .symmetryObject, .cycleGraph {
          text-align: center;
       }
       a:link {
          color: black;
       }
       a:hover {
          color: -webkit-link;
       }

       .sort-up:after,
       .sort-down:after,
       .sort-none:after {
          content: '';
          position: relative;
          left: 10px;
          border: 7px solid transparent;
       }
       .sort-up:after {
          top: 10px;
          border-top-color: #787878;
       }
       .sort-down:after {
          bottom: 10px;
          border-bottom-color: #787878;
       }
       .sort-none:after {
          border-top-color: transparent;
          border-bottom-color: transparent;
       }
       .sort-up,
       .sort-down,
       .sort-none {
          padding-right: 10px;
       }

       #tooltip {
          background-color: #FFFFD6;		/* light yellow (matches subset display) */
          border: 1px solid #CFCFCF;		/* ~silver */
          box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);	/* gray mist */
          color: #000000;
          font-size: medium;
          font-style: normal;
          font-weight: normal;
          padding: 1em;
          position: fixed;
          z-index: 1;
          white-space: nowrap;
          list-style-type: none;
          visibility: visible;
       }
      </style>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
      <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
          CommonHTML: {
             scale: 90,
          },
       });
      </script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=MML_CHTML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/95/three.js"></script>
      <script src="./build/allGroupExplorer.js"></script>
      <script src="./groupURLs.js"></script>

      <script>
       // Global variables
       var graphicContext;	// hidden scratchpad, re-used to reduce WebGL contexts
       var multtableContext;
       var cycleGraphContext;

       // Static event managers (setup after document is available)
       $(function() {
          $('#GroupTableHeaders th:nth-child(1)').on('click', () => columnSort(0));
          $('#GroupTableHeaders th:nth-child(2)').on('click', () => columnSort(1));
          $('#GroupTable tbody').on('click', HoverHelp.eventHandler)
                                .on('mousemove', HoverHelp.eventHandler)
                                .on('mouseleave', HoverHelp.eventHandler);
       });
       $(window).on('load', readLibrary);	// like onload handler in body


       // Load group library from urls
       function readLibrary() {
          window.graphicContext = new DisplayDiagram({width: 50, height: 50, fog: false});
          window.multtableContext = new DisplayMulttable({height: 32, width: 32});
          window.cycleGraphContext = new DisplayCycleGraph({height: 32, width: 32});

          // create mathjax style element from localStorage (needed to display locally stored definitions)
          const styleHTML = localStorage.getItem('mathjax_stylesheet');
          if (styleHTML != undefined) {
             $('head').append(styleHTML);
          }

          // only read in a few groups if URL specifies 'debug' (for impatient programmers)
          const urlDebug = new URL(window.location.href).searchParams.get('debug');
          const resolvedURLs = urls.map( (url) => Library.resolveURL(url) );
          const urlsToDisplay = (urlDebug == undefined) ?
                                Array.from(new Set(resolvedURLs.concat(Library.getAllLocalURLs()))) :
                                resolvedURLs.slice(0, (urlDebug || 10));

          // display locally stored group defintions
          for (const url of urlsToDisplay) {
             const g = Library.getLocalGroup(url);
             if (g != undefined && g.CayleyThumbnail != undefined && g.rowHTML != undefined) {
                const $img = $('<img>').attr('src', g.CayleyThumbnail).attr('height', 32).attr('width', 32);
                const $row = $(g.rowHTML);
                $row.find('td.cayleyDiagram').append($img);
                $('#GroupTable tbody').append($row);
             }
          }

          finish(urlsToDisplay);
       }

       function finish(urlsToDisplay) {
          const exit = () => {
             $( '#loadingMessage' ).hide();
             columnSort( 1, true );

             // store stylesheet in localStorage
             const mathjaxStylesheet = $('style').toArray().filter( (s) => s.textContent.trim().startsWith('.mjx-chtml') )[0];
             if (mathjaxStylesheet != undefined) {
                localStorage.setItem('mathjax_stylesheet',mathjaxStylesheet.outerHTML);
             }
          };

          columnSort(1, true);
          $( '#loadingMessage' ).show();

          // check that the locally stored definitions currently displayed are the latest; refresh if not
          const loadNextURL = (urlIndex) => {
             const url = urlsToDisplay[urlIndex++];
             const localGroup = Library.getLocalGroup(url);
             Library.getLatestGroup(url)
                    .then( (group) => {
                       // if we already have the latest group in the Library, just check to see if we're done
                       if (localGroup == group && localGroup.CayleyThumbnail != undefined && localGroup.rowHTML != undefined) {
                          if ( urlIndex == urlsToDisplay.length ) {
                             exit();
                          } else {
                             loadNextURL(urlIndex);
                          }
                       } else {
                          // format new group
                          const row = displayGroup(group)[0];
                          $('#ScratchTable').append(row);

                          // typeset this row
                          MathJax.Hub.Queue(
                             ['Typeset', MathJax.Hub, 'ScratchTable', () => {
                                // remove un-needed spans from mathjax output
                                $(row).find('span.MathJax_Preview, span.MJX_Assistive_MathML, script[type="math/mml"]').remove();
                                const $cayleyDiagram = $(row).find('td.cayleyDiagram img').detach();
                                group.rowHTML = row.outerHTML;
                                $(row).find('td.cayleyDiagram').append($cayleyDiagram);
                                $(row).detach().appendTo('#GroupTable tbody');
                                Library.saveGroup(group);
                                if ( urlIndex == urlsToDisplay.length ) {
                                   exit();
                                } else {
                                   const pct = ( urlIndex * 100 / urlsToDisplay.length ) | 0;
                                   $( '#loadingMessage i' ).html( `Loading groups (${pct}%)...` );
                                   loadNextURL(urlIndex);
                                }
                             }] );
                       } } )
                    .catch( console.error );
          }
          loadNextURL(0);
       }

       // add row to table that displays this name, order, etc. of group
       function displayGroup(group) {
          const cayleyTitle = (group.cayleyDiagrams.length == 0) ?
                              undefined :
                              group.cayleyDiagrams[0].name;
          const symmetryTitle = (group.symmetryObjects.length == 0) ?
                                undefined :
                                group.symmetryObjects[0].name;

          $(`tr[group="${group.URL}"]`).remove();
          let $row = $(eval(Template.HTML('row_template')));

          // draw Cayley diagram
          {
             const graphicData = new CayleyDiagram(group, cayleyTitle);
             const img = graphicContext.getImage(graphicData);
             group.CayleyThumbnail = img.src;
             img.height = img.width = 32;
             $row.find("td.cayleyDiagram").html(img);
          }

          // draw Multtable
          {
             const graphicData = new Multtable(group);
             const img = multtableContext.getImage(graphicData);
             $row.find("td.multiplicationTable").html(img);
          }

          // draw Symmetry Object
          if (group.symmetryObjects.length != 0) {
             const graphicData = SymmetryObject.generate(group, symmetryTitle);
             const img = graphicContext.getImage(graphicData);
             img.height = img.width = 32;
             $row.find("td.symmetryObject").html(img);
          }

          // draw Cycle Graph
          {
             const graphicData = new CycleGraph( group );
             const img = cycleGraphContext.getImage( graphicData );
             $row.find("td.cycleGraph").html(img);
          }

          return $row;
       }

       // callback to sort table on column value, invoked by clicking on column head
       function columnSort(columnIndex, makeSortUp = ! $($('th')[columnIndex]).hasClass('sort-up')) {
          for (let i = 0; i < 2; i++) {
             $($('th')[i]).removeClass('sort-down')
                          .removeClass('sort-up')
                          .addClass('sort-none');
          }
          $($('th')[columnIndex]).removeClass('sort-none')
                                 .addClass(makeSortUp ? 'sort-up' : 'sort-down');

          const getCellValue = (tr, idx) => tr.children[idx].textContent;

          const compareFunction =
             (idx, asc) =>
                (a, b) =>
                   ((v1, v2) => v1 !== '' &&
                              v2 !== '' &&
                              !isNaN(v1) &&
                              !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
                   )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

          $('#GroupTable tbody').find('tr:nth-child(n+1)')
                                .sort(compareFunction(columnIndex, makeSortUp))
                                .each((_,tr) => $('#GroupTable tbody').append(tr))
       }

       class HoverHelp {
          // pollerID = id of polling routine from window.setInterval call
          // mouse_event = event from last 'mousemove' event (event contains timestamp) (undefined => no mousemove event to be handled)
          // tooltip_timestamp = time tooltip was created (undefined => no tooltip being shown)

          static eventHandler(event) {
             if (event.ctrlKey || event.shiftKey || event.altKey) {
                return;
             }

             if (event.type == 'click') {
                // clear background, mouse_event, tooltip
                if (HoverHelp.mouse_event != undefined) {
                   $(HoverHelp.mouse_event.target).closest('td')
                                                  .css('background-color', '#FFFFFF')
                                                  .css('cursor', 'default');
                }
                HoverHelp.mouse_event = undefined;
                $('#tooltip').remove();

                // get td, class
                const $td = $(event.target).closest('td');
                if ($td.text() != 'none') {
                   for (const {klass, pageURL} of HoverHelp.data) {
                      if ($td.hasClass(klass)) {
                         const groupURL = $td.parent().attr('group');
                         const options = undefined;
                         Library.openWithGroupURL(pageURL, groupURL, options);
                         break;
                      }
                   }
                }
             } else if (event.type == 'mousemove') {
                const $old_td = (HoverHelp.mouse_event === undefined) ? undefined : $(HoverHelp.mouse_event.target).closest('td');
                const $new_td = $(event.target).closest('td');
                if ($old_td === undefined || $old_td[0] != $new_td[0]) {
                   if ($old_td !== undefined) {
                      $old_td.css('background-color', '#FFFFFF')
                             .css('cursor', 'default');
                   }
                   for (const {klass, background} of HoverHelp.data) {
                      if ($new_td.hasClass(klass) && $new_td.text() != 'none') {
                         $new_td.css('background-color', background)
                                .css('cursor', 'pointer');
                         break;
                      }
                   }
                   event.tooltip_shown = false;
                   $('#tooltip').remove();
                } else {
                   event.tooltip_shown = (HoverHelp.mouse_event === undefined) ? false : HoverHelp.mouse_event.tooltip_shown;
                }
                if ($new_td.text() != 'none') {
                   HoverHelp.mouse_event = event;
                }
             } else if (event.type = 'mouseleave') {
                // clear background
                if (HoverHelp.mouse_event != undefined) {
                   $(HoverHelp.mouse_event.target).closest('td')
                                                  .css('background-color', '#FFFFFF')
                                                  .css('cursor', 'default');
                }
                // clear mouse_event, tooltip
                HoverHelp.mouse_event = undefined;
                $('#tooltip').remove();
             }
          }

          static poller() {
             if (   HoverHelp.mouse_event !== undefined
                 && !HoverHelp.mouse_event.tooltip_shown
                 && $(HoverHelp.mouse_event.target).closest('td') !== undefined
                 && performance.now() - HoverHelp.mouse_event.timeStamp > 500) {
                const $td = $(HoverHelp.mouse_event.target).closest('td');
                for (const {klass, tooltip} of HoverHelp.data) {
                   if ($td.hasClass(klass)) {
                      const $tooltip = $('<div id="tooltip" class="menu">')
                         .attr('timestamp', performance.now())
                         .text(tooltip)
                         .appendTo($td);
                      Menu.setMenuLocations(HoverHelp.mouse_event, $tooltip);
                      HoverHelp.mouse_event.tooltip_shown = true;
                      break;
                   }
                }
             }

             // if tooltip is more than 10 sec old, clear it
             if ($('#tooltip')[0] !== undefined && performance.now() - $('#tooltip').attr('timestamp') > 10000) {
                $('#tooltip').remove()
             }
          }
       }

       HoverHelp.data = [
          {klass: 'groupName', pageURL: 'GroupInfo.html', background: '#F2F2F2', tooltip: 'Open Group Info page'},
          {klass: 'definition', pageURL: 'GroupInfo.html', background: '#F2F2F2', tooltip: 'Open Group Info page'},
          {klass: 'cayleyDiagram', pageURL: 'CayleyDiagram.html', background: '#F7EDED', tooltip: 'Open Cayley Diagram visualizer'},
          {klass: 'multiplicationTable', pageURL: 'Multtable.html', background: '#F2FFD6', tooltip: 'Open Multiplication Table visualizer'},
          {klass: 'symmetryObject', pageURL: 'SymmetryObject.html', background: '#EDF7ED', tooltip: 'Open Symmetry Object visualizer'},
          {klass: 'cycleGraph', pageURL: 'CycleDiagram.html', background: '#EDEDF7', tooltip: 'Open Cycle Graph Visualizer'},
       ]
       HoverHelp.pollerID = setInterval(HoverHelp.poller, 500);
      </script>
   </head>
   <body>
      <!-- <h2 align="center">Group Explorer</h2> -->
      <div style='text-align: center;'>
         <img style='border: 1px solid black;' src='images/logo.png'/>
      </div>
      <br>
      <div class="top-right-menu">
         <div>
            <a href='index.html'>
               <i title="Project Home" class="fa fa-home fa-2x trm-blue"></i></a>
            <!--
               <a href='GroupExplorer.html'>
                  <i title="Group Library" class="fa fa-book fa-2x trm-blue"></i></a>
            -->
               <a href='Sheet.html' target='_blank'>
                  <i title="Sheets" class="fa fa-file trm-blue" style="font-size:1.5em;vertical-align:10%;"></i></a>
               <a href='help/index.html'>
                  <i title="Help" class="fa fa-question-circle fa-2x trm-blue"></i></a>
               <a href='https://github.com/nathancarter/group-explorer'>
                  <i title="Source on GitHub" class="fa fa-github fa-2x trm-blue"></i></a>
         </div>
         <div id="version" style="float: right; font-size: small; color: #2196f3;"></div>
         <script>document.getElementById('version').textContent = Version.label()</script>
      </div>

      <table id="ScratchTable" style="width: 100%; display: none"></table>

      <table id="GroupTable" style="width: 100%;">
         <thead>
            <tr id="GroupTableHeaders" height="32px">
               <th class="sort-none">Name</th>
               <th class="sort-none"><a href="help/rf-groupterms/index.html#order-of-a-group">Order</a></th>
               <th><a href="help/rf-groupterms/index.html#definition-of-a-group-via-generators-and-relations">Definition</a></th>
               <th class="diagramHeader"><a href="help/rf-groupterms/index.html#cayley-diagrams">Cayley diagram</a></th>
               <th class="diagramHeader"><a href="help/rf-groupterms/index.html#multiplication-table">Multiplication table</a></th>
               <th class="diagramHeader"><a href="help/rf-groupterms/index.html#objects-of-symmetry">Object of symmetry</a></th>
               <th class="diagramHeader"><a href="help/rf-groupterms/index.html#cycle-graph">Cycle graph</a></th>
            </tr>
            <tr id="loadingMessage" class="hidden">
               <th colspan=7>
                  <center><i class="slowflash">Loading groups...</i></center>
               </th>
            </tr>
         </thead>
         <tbody>
         </tbody>
      </table>

      <template id="row_template">
         <tr group="${group.URL}">
            <td class="groupName">
               ${ (group.nameHTML === undefined) ? MathML.sans(group.name) : group.nameHTML }
            </td>
            <td class="groupOrder">${ group.order }</td>
            <td class="definition">
               ${ (group.definitionHTML === undefined) ? MathML.sans(group.definition) : group.definitionHTML }
            </td>
            <td class="cayleyDiagram"></td>
            <td class="multiplicationTable"></td>
            <td class="symmetryObject">none</td>
            <td class="cycleGraph"></td>
         </tr>
      </template>
   </body>
</html>
