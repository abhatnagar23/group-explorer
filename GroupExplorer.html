<html>
   <head>
      <title>Group Explorer Library</title>

      <link rel="icon" type="image/png" href="./images/favicon.png"></link>
      <link rel="stylesheet" href="./style/fonts.css" type="text/css"></link>
      <link rel="stylesheet" href="./style/menu.css" type="text/css"></link>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

      <style type="text/css">
       .hidden {
          display: none;
       }
       table, th, td {
          border: 1px solid #A0A0A0;
          border-collapse: collapse;
          vertical-align: middle;
       }
       .diagramHeader {
          width: 100px;
       }
       .groupName {
          font-size: large;
       }
       .groupOrder {
          text-align: center;
       }
       .cayleyDiagram, .multiplicationTable, .symmetryObject, .cycleGraph {
          text-align: center;
       }
       a:link {
          color: black;
       }
       a:hover {
          color: -webkit-link;
       }

       .sort-up:after,
       .sort-down:after,
       .sort-none:after {
          content: '';
          position: relative;
          left: 10px;
          border: 7px solid transparent;
       }
       .sort-up:after {
          top: 10px;
          border-top-color: #787878;
       }
       .sort-down:after {
          bottom: 10px;
          border-bottom-color: #787878;
       }
       .sort-none:after {
          border-top-color: transparent;
          border-bottom-color: transparent;
       }
       .sort-up,
       .sort-down,
       .sort-none {
          padding-right: 10px;
       }

       .top-right-menu {
          position: absolute;
          right: 0;
          top: 0;
          margin: 10px;
       }
       a:link .trm-item {
          color: #2196f3;
       }
       a:visited .trm-item {
          color: #2196f3;
       }
       a:hover .trm-item {
          color: #2196f3;
       }
       a:active .trm-item {
          color: #2196f3;
       }
      </style>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
      <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
          CommonHTML: {
             scale: 90,
          },
          "fast-preview": {
             disabled: false,
          },
       });
      </script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=MML_CHTML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/95/three.js"></script>
      <script src="./build/allGroupExplorer.js"></script>
      <script src="./groupURLs.js"></script>

      <script>
       // Global variables
       var graphicContext;	// hidden scratchpad, re-used to reduce WebGL contexts
       var multtableContext;
       var cycleGraphContext;

       // Static event managers (setup after document is available)
       $(function() {
          $('#GroupTableHeaders th:nth-child(1)').on('click', () => columnSort(0));
          $('#GroupTableHeaders th:nth-child(2)').on('click', () => columnSort(1));
       });
       $(window).on('load', readLibrary);	// like onload handler in body

       // Load group library from urls
       function readLibrary() {
          window.graphicContext = new DisplayDiagram({width: 50, height: 50, fog: false});
          window.multtableContext = new DisplayMulttable({height: 32, width: 32});
          window.cycleGraphContext = new DisplayCycleGraph({height: 32, width: 32});

          // only read in a few groups if URL specifies 'debug' (for impatient programmers)
          const urlDebug = new URL(window.location.href).searchParams.get('debug');
          const urlsToDisplay = (urlDebug == undefined) ?
                                Array.from(new Set(urls.concat(Library.getAllLocalURLs()))) :
                                urls.slice(0, (urlDebug || 10));

          // display locally stored group defintions
          for (const url of urlsToDisplay) {
             const g = Library.getLocalGroup(url);
             if (g != undefined) {
                displayGroup(g);
             }
          }

          if (Library.isEmpty()) {
             finish(urlsToDisplay);
          } else {
             MathJax.Hub.Queue( ['Typeset', MathJax.Hub, $(`#GroupTable`)[0],
                                 () => {
                                    $(`#GroupTable tbody tr`).show();
                                    finish(urlsToDisplay);
                                 }] );
          }
       }

       function finish(urlsToDisplay) {
          columnSort(1, true);
          $( '#loadingMessage' ).show();
          
          // check that the locally stored definitions currently displayed are the latest; refresh if not
          let numGroupsToLoad = urlsToDisplay.length;
          let numGroupsLoaded = 0;
          const loadNextURL = (urls) => {
             url = urls.pop();
             const localGroup = Library.getLocalGroup(url);
             Library.getLatestGroup(url)
                    .then( (group) => {
                       // if we already had the group and it's current, just check to see if we're done
                       if (localGroup != undefined && group.lastModifiedOnServer == localGroup.lastModifiedOnServer) {
                          if ( ++numGroupsLoaded == numGroupsToLoad ) {
                             $( '#loadingMessage' ).hide();
                             columnSort( 1, true );
                          } else if (urls.length > 0) {
                             loadNextURL(urls);
                          }
                       } else {
                          // format new group
                          const row = displayGroup(group)[0];

                          // typeset this row
                          MathJax.Hub.Queue(['Typeset', MathJax.Hub, row, function () {
                             $(row).show();
                             if ( ++numGroupsLoaded == numGroupsToLoad ) {
                                $( '#loadingMessage' ).hide();
                                columnSort( 1, true );
                             } else if (urls.length > 0) {
                                const pct = ( numGroupsLoaded * 100 / numGroupsToLoad ) | 0;
                                $( '#loadingMessage i' ).html( `Loading groups (${pct}%)...` );
                                loadNextURL(urls);
                             }
                          } ]);
                       } } )
                    .catch( console.error );
          }
          loadNextURL(urlsToDisplay);
       }

       // add row to table that displays this name, order, etc. of group
       function displayGroup(group) {
          const cayleyTitle = (group.cayleyDiagrams.length == 0) ?
                              undefined :
                              group.cayleyDiagrams[0].name;
          const symmetryTitle = (group.symmetryObjects.length == 0) ?
                                undefined :
                                group.symmetryObjects[0].name;

          let $row = $(`#GroupTable tr[group="${group.URL}"]`);
          if ($row.length == 0) {
             $row = $(eval(Template.HTML('row_template')));
          } else {
             $($row[0].children[0].children[0]).html(MathML.sans(group.name));
             $($row[0].children[2].children[0]).html(MathML.sans(group.definition));
          }
          $row.attr('group', group.URL)

          // draw Cayley diagram
          let img;
          if (group.CayleyThumbnail === undefined) {
             const  graphicData = new CayleyDiagram(group, cayleyTitle);
             img = graphicContext.getImage(graphicData);
             group.CayleyThumbnail = img.src;
          } else {
             img = new Image();
             img.src = group.CayleyThumbnail;
          }
          img.height = img.width = 32;
          $row.find("td.cayleyDiagram > a").html(img);

          // draw Multtable
          if (group.multtableThumbnail === undefined) {
             const graphicData = new Multtable(group);
             img = multtableContext.getImage(graphicData);
             group.multtableThumbnail = img.src;
          } else {
             img = new Image();
             img.src = group.multtableThumbnail;
          }
          $row.find("td.multiplicationTable > a").html(img);

          // draw Symmetry Object
          if (group.symmetryObjects.length != 0) {
             if (group.symmetryObjectThumbnail === undefined) {
                const graphicData = SymmetryObject.generate(group, symmetryTitle);
                img = graphicContext.getImage(graphicData);
                group.symmetryObjectThumbnail = img.src;
             } else {
                img = new Image();
                img.src = group.symmetryObjectThumbnail;
             }
             img.height = img.width = 32;
             $row.find("td.symmetryObject > a").html(img);
          } else {
             $row.find("td.symmetryObject").text('none');
          }

          // draw Cycle Graph
          if (group.cycleGraphThumbnail === undefined) {
             const graphicData = new CycleGraph( group );
             img = cycleGraphContext.getImage( graphicData );
             group.cycleGraphThumbnail = img.src;
             Library.saveGroup(group);
          } else {
             img = new Image();
             img.src = group.cycleGraphThumbnail;
          }
          $row.find("td.cycleGraph > a").html(img);

          $row.appendTo($('#GroupTable tbody'));

          return $row;
       }

       // callback to sort table on column value, invoked by clicking on column head
       function columnSort(columnIndex, makeSortUp = ! $($('th')[columnIndex]).hasClass('sort-up')) {
          for (let i = 0; i < 2; i++) {
             $($('th')[i]).removeClass('sort-down')
                          .removeClass('sort-up')
                          .addClass('sort-none');
          }
          $($('th')[columnIndex]).removeClass('sort-none')
                                 .addClass(makeSortUp ? 'sort-up' : 'sort-down');

          const getCellValue = (tr, idx) => tr.children[idx].textContent;

          const compareFunction =
             (idx, asc) =>
                (a, b) =>
                   ((v1, v2) => v1 !== '' &&
                              v2 !== '' &&
                              !isNaN(v1) &&
                              !isNaN(v2) ? v1 - v2 : v1.toString().localeCompare(v2)
                   )(getCellValue(asc ? a : b, idx), getCellValue(asc ? b : a, idx));

          $('#GroupTable tbody').find('tr:nth-child(n+1)')
                                .sort(compareFunction(columnIndex, makeSortUp))
                                .each((_,tr) => $('#GroupTable tbody').append(tr))
       }
      </script>
   </head>
   <body>
      <!-- <h2 align="center">Group Explorer</h2> -->
      <div style='text-align: center;'>
         <img style='border: 1px solid black;' src='images/logo.png'/>
      </div>
      <br>
      <div class="top-right-menu">
         <a href='index.html'><i title="Project Home" class="fa fa-home fa-2x trm-blue"></i></a>
         <!--
              <a href='GroupExplorer.html'><i title="Group Library"
              class="fa fa-book fa-2x trm-blue"></i></a>
         -->
         <a href='Sheet.html'><i title="Sheets" class="fa fa-file trm-blue"
                                 style="font-size:1.5em;vertical-align:10%;"></i></a>
         <a href='help/rf-groupterms.html'><i title="Help"
                                              class="fa fa-question-circle fa-2x trm-blue"></i></a>
         <a href='https://github.com/nathancarter/group-explorer'><i title="Source on GitHub"
                                                                     class="fa fa-github fa-2x trm-blue"></i></a>
      </div>
      <table id="GroupTable" style="width: 100%;">
         <thead>
            <tr id="GroupTableHeaders" height="32px">
               <th class="sort-none">Name</th>
               <th class="sort-none">Order</th>
               <th>Definition</th>
               <th class="diagramHeader">Cayley diagram</th>
               <th class="diagramHeader">Multiplication table</th>
               <th class="diagramHeader">Object of symmetry</th>
               <th class="diagramHeader">Cycle graph</th>
            </tr>
            <tr id="loadingMessage" class="hidden">
               <th colspan=7>
                  <center><i class="slowflash">Loading groups...</i></center>
               </th>
            </tr>
         </thead>
         <tbody>
         </tbody>
      </table>
      <template id="row_template">
         <tr style="display: none">
            <td class="groupName">
               <a title="Open GroupInfo page"
                  href="javascript:Library.openWithGroupURL('GroupInfo.html', '${group.URL}')">${ MathML.sans(group.name) }</a>
            </td>
            <td class="groupOrder">${ group.order }</td>
            <td class="description">
               <a title="Open GroupInfo page"
                  href="javascript:Library.openWithGroupURL('GroupInfo.html', '${group.URL}')">${ MathML.sans(group.definition) }</a>
            </td>
            <td class="cayleyDiagram">
               <a title="Open Cayley diagram visualizer"
                  href="javascript:Library.openWithGroupURL('CayleyDiagram.html', '${group.URL}', {diagram: '${cayleyTitle}'})"></a>
            </td>
            <td class="multiplicationTable">
               <a title="Open multiplication table visualizer"
                  href="javascript:Library.openWithGroupURL('Multtable.html', '${group.URL}')"></a>
            </td>
            <td class="symmetryObject">
               <a title="Open object of symmetry visualizer"
                  href="javascript:Library.openWithGroupURL('SymmetryObject.html', '${group.URL}', {diagram: '${symmetryTitle}'})"></a>
            </td>
            <td class="cycleGraph">
               <a title="Open cycle graph visualizer"
                  href="javascript:Library.openWithGroupURL('CycleDiagram.html', '${group.URL}')"></a>
            </td>
         </tr>
      </template>
   </body>
</html>
