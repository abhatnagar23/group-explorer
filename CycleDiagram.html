<html>
   <head>
      <link rel="icon" type="image/png" href="./images/favicon.png"></link>
      <link rel="stylesheet" href="./style/fonts.css" type="text/css"></link>
      <link rel="stylesheet" href="./style/sliders.css" type="text/css"></link>
      <link rel="stylesheet" href="./visualizerFramework/visualizer.css" type="text/css"></link>
      <link rel="stylesheet" href="./subsetDisplay/subsets.css" type="text/css"></link>
      <link rel="stylesheet" href="./style/menu.css" type="text/css"></link>

      <style>
       #graphic {
          overflow: hidden;
          background-color: #C8C8F0;
       }
      </style>

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
      <script type="text/x-mathjax-config">
       MathJax.Hub.Config({
          CommonHTML: {
             scale: 95,
          },
          showMathMenu: false,
       });
      </script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=MML_CHTML"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/95/three.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/jquery-resizable-dom@0.32.0/dist/jquery-resizable.js"></script>
      <script src="./build/allGroupExplorer.js"></script>
      <script src="./build/allVisualizer.js"></script>
      <script>
       // global variables
       var group,		// group about which information will be displayed
           cyclegraph,    // data being displayed in large diagram
           graphicContext;	// graphic context for large diagram

       // Static event managers (called after document is assembled)
       function registerCallbacks() {
          $('#help').on('click', help);
          $('#reset').on('click', load);

          // mouse events in large graphic
          $('#graphic').on('wheel', graphicEventHandler);
          $('#graphic').on('contextmenu', graphicEventHandler);
          $('#graphic').on('mouseenter', graphicEventHandler);
          $('#graphic').on('mousemove', graphicEventHandler);
          $('#graphic').on('moveleave', graphicEventHandler);
          $('#graphic').on('mousedown', graphicEventHandler);
          $('#graphic').on('mouseup', graphicEventHandler);
       }
       $(window).on('load', load);	// like onload handler in body
       $(window).on('resize', resizeBody);

       function load() {
          // Promise to load group from invocation URL
          const groupLoad = Library
             .loadFromInvocation()
             .then( ({library, groupIndex}) => {
                group = library[groupIndex];
             } );

          // Promise to load visualizer framework around visualizer-specific code in this file
          const bodyLoad = VC.load();

          // When group and framework are loaded, insert subset_page and complete rest of setup
          Promise.all([groupLoad, bodyLoad])
                 .then( () => SSD.load($('#subset-control')).then(completeSetup) )
                 .catch( (error) => alert(error) );
       }


       /* Now that subsetDisplay is loaded, complete the setup */
       function completeSetup() {
          // Register event handlers
          registerCallbacks();

          // Create header from group name and queue MathJax to typeset it
          $('#header').html('Cycle Graph for&nbsp;' + math(group.name));
          MathJax.Hub.Queue(['Typeset', MathJax.Hub]);

          // Create list of subgroups for select options, one choice for each proper subgroup
          //   (Note that counting starts at 1; subgroup 0, the identity group, is already filled in by static HTML)
          for (let inx = 1; inx < group.subgroups.length - 1; inx++) {
             // Recursive routine calculates multi-character subscript as Unicode text, since <option> tags cannot contain HTML
             // (We could also roll our own <select> here)
             const subscript = (jnx) =>
                (jnx == 0) ? '' : (subscript(Math.floor(jnx / 10)) + subscripts[jnx % 10]);  // subscripts defined in js/mathmlUtils.js
             const subgroup = group.subgroups[inx];
             const option =  eval(Template.HTML('organization-choice-template'));
             $('#organization-select').append(option);
          }

          // Create Cycle Graph, graphic context (it will be displayed in resizeBody below)
          cyclegraph = new CycleGraph(group);
          graphicContext = new DisplayCycleGraph({container: $('#graphic')});

          // Register the splitter with jquery-resizable, so you can resize the graphic horizontally
          // by grabbing the border between the graphic and the subset control and dragging it
          $('#vert-container').resizable({
             handleSelector: '#splitter',
             resizeHeight: false,
             resizeWidthFrom: 'left',
             onDrag: resizeGraphic,
          });

          resizeBody();
       }

       function resizeBody() {
          $('body').height(window.innerHeight - 8);
          $('body').width(window.innerWidth - 8);

          resizeGraphic();
       };

       function resizeGraphic() {
          graphicContext.showLargeGraphic(cyclegraph);
       }


       /*
        * Large graphic events
        *
        * Mouse wheel -- zoom in/out
        * Right click -- zoom to fit
        * Mouse enter -- start handling mouse move
        * Mouse move -- cancel existing timer, start new hover help timer
        * Mouse leave -- cancel existing timer, quit handling mouse move
        * Mouse down -- save location
        * Mouse up -- process changed location
        */

       const Handlers = new Map()
          .set('wheel', zoom)
          .set('contextmenu', zoom2fit)
          .set('mouseenter', startHoverSense)
          .set('mousemove', startHover)
          .set('moveleave', leaveGraphic)
          .set('mousedown', startDrag)
          .set('mouseup', stopDrag);

       function graphicEventHandler(event) {
          const handler = Handlers.get(event.type);
          if (handler !== undefined) {
             event.preventDefault();
             handler.call(window, event);
             event.stopPropagation();
             resizeGraphic();
          }
       }

       function zoom(event) {
          graphicContext.zoom += 0.1 * (event.originalEvent.deltaY < 0 ? 1 : -1);
       }

       function zoom2fit(event) {
          graphicContext.zoom = 1;
          graphicContext.translation = [0,0];
       }

       let Hover_timer = undefined;
       function startHoverSense(event) {
          const hoverTimer = function () {
             // don't display hover help in the middle of a drag-and-drop operation
             if (Drag_start === undefined) {
                // create new canvas, child of graphic
                // place at event
                // get context, paint text
                // console.log(`location: ${event.originalEvent.clientX} x ${event.originalEvent.clientY}`);
             }
          };
          Hover_timer = setTimeout(hoverTimer, 400);
       }

       function startHover(event) {
          stopHoverSense(event);
          startHoverSense(event);
       }

       function stopHoverSense(event) {
          Hover_timer = clearTimeout(Hover_timer);
       }

       function leaveGraphic(event) {
          stopHoverSense(event);
          Drag_start = undefined;
       }

       let Drag_start = undefined;
       function startDrag(event) {
          Drag_start = [event.originalEvent.clientX, event.originalEvent.clientY];
       }

       function stopDrag(event) {
          graphicContext.translation = [
             graphicContext.translation[0] + (event.originalEvent.clientX - Drag_start[0]),
             graphicContext.translation[1] + (event.originalEvent.clientY - Drag_start[1])
          ];
          Drag_start = undefined;
       }


       /* Show the desired panel, hide the rest */
       function showPanel(panel_name) {
          for (const name of panelNames) {
             if (name == panel_name) {
                $(name).show();
             } else {
                $(name).hide();
             }
          }
       }

       function help() {
          alert('There is no help for you. (yet)');
       }


       /* Highlighting routines */
       function highlightByBackground(elements) {
          cyclegraph.highlightByBackground(elements);
          graphicContext.showLargeGraphic(cyclegraph);
       }

       function highlightByBorder(elements) {
          cyclegraph.highlightByBorder(elements);
          graphicContext.showLargeGraphic(cyclegraph);
       }

       function highlightByTop(elements) {
          cyclegraph.highlightByTop(elements);
          graphicContext.showLargeGraphic(cyclegraph);
       }

       function clearHighlights() {
          cyclegraph.clearHighlights();
          graphicContext.showLargeGraphic(cyclegraph);
       }
      </script>
   </head>
   <body class="vert">
      <div id="control-options" class="horiz">
         <button id="subset-button">Subsets</button>
      </div>

      <div id="subset-control" class="fill-vert">
         <!-- This is filled in by subsetDisplay/subsets.html -->
      </div>

      <!-- Templates for highlighting control menus in subsetDisplay -->
      <template class="subgroup-extension subset-extension partition-extension">
         <li>Highlight item by<span class="menu-arrow"></span>
            <ul>
               <li action="highlightByBackground([${this.elementString}])">Background</li>
               <li action="highlightByBorder([${this.elementString}])">Border</li>
               <li action="highlightByTop([${this.elementString}])">Top</li>
            </ul>
         </li>
      </template>
      <template class="partition-extension">
         <li>Highlight partition by<span class="menu-arrow"></span>
            <ul>
               <li action="highlightByBackground(${this.parent.allElementString})">Background</li>
               <li action="highlightByBorder(${this.parent.allElementString})">Border</li>
               <li action="highlightByTop(${this.parent.allElementString})">Top</li>
            </ul>
         </li>
      </template>
      <template class="subgroup-extension subset-extension partition-extension">
         <li action="clearHighlights()">Clear all highlighting</li>
      </template>
   </body>
</html>
